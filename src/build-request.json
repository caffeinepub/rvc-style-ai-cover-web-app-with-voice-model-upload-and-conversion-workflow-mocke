{
  "kind": "build_request",
  "title": "Rebuild voice conversion so completed jobs play the actual model-voiced output",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Scrap and rebuild the client-side voice conversion integration so it reliably produces (and saves) audio that uses the selected voice model’s voice (no silent fallback to returning the original audio).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages-4"
        ],
        "quotes": [
          "No. It’s still doing that thing where it’s just not playing the model with the output. Scrap the code for that and do it again."
        ]
      },
      "acceptanceCriteria": [
        "If Replicate is not configured (missing VITE_REPLICATE_API_TOKEN), the app must show a clear, user-facing error explaining what is missing and must not create a completed job with unconverted/original audio.",
        "If Replicate conversion fails (API error, polling failure, invalid response), the app must show a clear, user-facing error and must not create a completed job containing unconverted/original audio.",
        "The conversion request must be made using the voice model the user selected (not a hardcoded/default/undefined model input)."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Update the conversion pipeline to pass the selected voice model’s actual data URL into the Replicate conversion call by retrieving the selected model from the backend and using its ExternalBlob direct URL as the model input for conversion.",
      "target": "both",
      "source": {
        "messageIds": [
          "recent-messages-4"
        ],
        "quotes": [
          "it’s just not playing the model with the output"
        ]
      },
      "acceptanceCriteria": [
        "When a user selects a model and submits audio, the frontend must resolve the selected model to a concrete model resource URL derived from the stored model blob (ExternalBlob.getDirectURL()), and use that URL in the conversion request.",
        "If the selected model cannot be fetched / has no usable URL, the submit must fail with a clear error and must not create a job.",
        "The created job in the backend must store the converted audio bytes as the completed job blob (i.e., preview/download uses the converted audio)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Rebuild frontend audio playback for completed jobs to be robust across browsers by creating a Blob/ObjectURL for preview (instead of relying solely on playing the ExternalBlob direct URL), and ensure playback state and cleanup are handled correctly.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages-4"
        ],
        "quotes": [
          "it’s just not playing the model with the output"
        ]
      },
      "acceptanceCriteria": [
        "Clicking “Preview” on a completed job must play audio that matches the job’s stored completed blob.",
        "Stopping/starting preview must work reliably (second click stops, subsequent click restarts).",
        "Any ObjectURLs created for preview must be revoked when no longer needed (on stop/end/unmount) to avoid leaks.",
        "If playback fails, the UI must surface a user-facing error (not only console logs)."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Replace the current Replicate request/response handling with a robust implementation that can handle common Replicate output shapes and avoids unsafe base64 conversions that can corrupt large audio files.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages-4"
        ]
      },
      "acceptanceCriteria": [
        "The code must not rely on `btoa(String.fromCharCode(...bytes))` for arbitrary-sized audio (it must use a safe approach that does not overflow call stacks or corrupt data).",
        "The implementation must correctly handle Replicate `output` fields that may be a string URL or a list of URLs and choose the correct audio URL to download.",
        "Progress/status updates shown in the UI must reflect Replicate polling states (starting/processing/succeeded/failed) and transition to completion only after the converted audio has been downloaded and stored."
      ]
    }
  ],
  "constraints": [
    "Do not edit files under frontend/src/components/ui (read-only).",
    "Do not edit immutable paths: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx.",
    "Backend must remain single-actor with all Motoko logic in backend/main.mo; only add migration.mo if a state/schema upgrade is required."
  ],
  "nonGoals": [
    "Do not add new backend services or external databases.",
    "Do not add third-party authentication providers (Internet Identity only).",
    "Do not implement real-time streaming/audio via WebSockets.",
    "Do not change the overall product scope beyond fixing the model-voiced output generation and playback reliability."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}