{
  "kind": "build_request",
  "title": "Fix “Load failed” error when creating an AI cover",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Improve error handling for the Replicate API calls used during cover creation so that generic browser/network errors (e.g., fetch throwing a TypeError that surfaces as “Load failed”) are caught and converted into a clear, user-facing error message that includes the failing step (create prediction, poll prediction, download result) and the HTTP status/body when available.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Ok, now it’s saying load failed when I try to make a cover, can you try and fix it?"
        ]
      },
      "acceptanceCriteria": [
        "When Replicate POST /v1/predictions fails, the UI displays an InlineAlert/toast message that includes the HTTP status code and response text (when available).",
        "When polling GET /v1/predictions/{id} fails, the UI displays an InlineAlert/toast message that indicates the status-check step failed and includes HTTP status code (when available).",
        "When downloading the final output audio URL fails, the UI displays an InlineAlert/toast message that indicates the download step failed and includes HTTP status code (when available).",
        "When fetch fails before an HTTP response is available (e.g., network/CORS), the UI displays a friendly message (in English) such as “Network request failed while contacting Replicate. Check your connection and that the Replicate API token is configured.” instead of a vague “Load failed”."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Add a preflight configuration check on the Create Cover flow to detect when `VITE_REPLICATE_API_TOKEN` is missing/empty at runtime and block submission with a clear on-page error explaining that AI cover creation requires a Replicate API token and how to configure it (referencing `VITE_REPLICATE_API_TOKEN`).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Ok, now it’s saying load failed when I try to make a cover, can you try and fix it?"
        ]
      },
      "acceptanceCriteria": [
        "If `import.meta.env.VITE_REPLICATE_API_TOKEN` is empty, the Create Cover page shows an InlineAlert (destructive or info) explaining that the token is not configured and the submit button is disabled or submission is prevented with the same message.",
        "If the token is present, the Create Cover page behaves as it does today (no additional blocking UI)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Ensure the audio MIME type used when converting uploaded audio bytes to a data URL is derived from the uploaded file (with safe fallbacks) rather than always using `audio/mpeg`, to reduce conversion failures for non-MP3 uploads.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Ok, now it’s saying load failed when I try to make a cover, can you try and fix it?"
        ]
      },
      "acceptanceCriteria": [
        "Uploading a WAV/M4A/OGG file uses the file’s MIME type (or an appropriate fallback like `application/octet-stream` when missing) when building the data URL sent to Replicate.",
        "Existing MP3 upload flow continues to work."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Add lightweight diagnostic logging (console-level) around the cover creation pipeline to help identify where failures occur (model URL fetch, Replicate create, Replicate poll, result download, backend save), without exposing the Replicate API token in logs.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Ok, now it’s saying load failed when I try to make a cover, can you try and fix it?"
        ]
      },
      "acceptanceCriteria": [
        "Console logs identify the current pipeline step and key non-secret metadata (e.g., job id, Replicate prediction id, statuses) and never print the token value.",
        "Logs are present only in the cover creation path and do not significantly spam during normal use (e.g., poll logs are rate-limited or summarized)."
      ]
    }
  ],
  "constraints": [
    "Frontend immutable paths must not be edited: frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useInternetIdentity.tsx, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, frontend/src/components/ui.",
    "Backend must remain single-actor Motoko architecture (backend/main.mo); only add a migration file if existing stable state needs schema changes.",
    "Use English for any user-facing text."
  ],
  "nonGoals": [
    "Adding new third-party authentication providers (only Internet Identity is supported).",
    "Moving Replicate calls to the backend (backend cannot call external APIs).",
    "Adding real-time/WebSocket updates for job progress."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}