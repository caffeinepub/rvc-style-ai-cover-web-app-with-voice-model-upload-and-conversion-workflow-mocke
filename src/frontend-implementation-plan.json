{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "In-app Replicate API token configuration (client-side)",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Add an in-app token settings UI in the Create Cover flow to enter/save/reveal/clear the Replicate API token, with clear client-only storage messaging.",
      "acceptanceCriteria": [
        "On the Create Cover flow, when no token is configured, the UI provides an input to paste a Replicate API token and a clear call-to-action to save it.",
        "The token input is masked by default with an option to reveal it.",
        "The UI provides a \"Clear token\" action that removes the stored token.",
        "User-facing text is in English and clearly indicates the token is stored on the client (browser) and not uploaded to the app backend."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/ReplicateTokenCard.tsx",
          "operation": "create",
          "description": "Create a Create-Cover-friendly settings card that lets the user paste a Replicate API token, save it to client storage, reveal/mask it, and clear it. Include English helper text stating the token is stored in the browser only and is not uploaded to the app backend."
        },
        {
          "path": "frontend/src/pages/CreateCoverPage.tsx",
          "operation": "modify",
          "description": "Wire the new ReplicateTokenCard into the Create Cover flow: when Replicate is not configured, show the token UI with a clear save call-to-action and client-only storage messaging, and ensure the rest of the flow is clearly gated until configured."
        },
        {
          "path": "frontend/src/components/AudioUploadAndSubmit.tsx",
          "operation": "modify",
          "description": "Update Create Cover form gating UI to reflect in-app configuration (not just .env), and ensure controls are disabled when Replicate is not configured with a clear, English message pointing users to configure the token in-app (stored client-side)."
        }
      ]
    },
    {
      "id": "REQ-2",
      "summary": "Persist the token client-side and update Replicate configuration checks and voice conversion runtime token selection with env fallback; keep hard-blocking when absent and never send token to backend.",
      "acceptanceCriteria": [
        "`isReplicateConfigured()` returns true when either a saved (runtime) token exists or `VITE_REPLICATE_API_TOKEN` is present.",
        "`convertVoiceWithReplicate(...)` uses the saved (runtime) token when available, otherwise falls back to `VITE_REPLICATE_API_TOKEN`.",
        "If neither token source exists (or the token is empty), voice conversion remains hard-blocked with a clear error message (no silent failures).",
        "The token is never sent to the Motoko backend in any API call or stored in backend state."
      ],
      "file_operations": [
        {
          "path": "frontend/src/services/replicateToken.ts",
          "operation": "create",
          "description": "Add a small client-only token persistence service (get/save/clear) backed by browser storage (e.g., localStorage) and a lightweight change notification mechanism so UI can update without reload."
        },
        {
          "path": "frontend/src/hooks/useReplicateToken.ts",
          "operation": "create",
          "description": "Add a React hook that exposes the current saved runtime token (and change events) so the Create Cover flow can re-render immediately after save/clear without page reload."
        },
        {
          "path": "frontend/src/services/voiceConversion.ts",
          "operation": "modify",
          "description": "Update Replicate configuration logic to check for a saved runtime token first and fall back to `import.meta.env.VITE_REPLICATE_API_TOKEN`. Ensure `isReplicateConfigured()` and `convertVoiceWithReplicate(...)` use the runtime token when present, otherwise env fallback, and throw a clear error when neither exists. Ensure the token is only used in client-side Replicate requests and is not passed to any backend capability."
        },
        {
          "path": "frontend/src/components/AudioUploadAndSubmit.tsx",
          "operation": "modify",
          "description": "Switch token gating to use the new reactive hook/service (so enabling happens instantly after saving a valid token). Ensure any preflight errors remain hard-blocking and user-readable when no token is available from either source."
        }
      ]
    },
    {
      "id": "REQ-3",
      "summary": "Add a client-side 'Test token' validation action in the token UI that calls Replicate and updates Create Cover enabled state without reload.",
      "acceptanceCriteria": [
        "The token UI includes a \"Test token\" action that makes a Replicate API request using the provided token and shows a success or error state.",
        "If validation fails, the UI shows a readable error and does not mark the token as valid/configured based solely on being non-empty.",
        "If validation succeeds, the Create Cover flow becomes enabled without requiring a page reload."
      ],
      "file_operations": [
        {
          "path": "frontend/src/services/replicateValidation.ts",
          "operation": "create",
          "description": "Add a client-side helper that performs a lightweight Replicate API request using a provided token and returns a success/error result suitable for UI display (no backend involvement)."
        },
        {
          "path": "frontend/src/components/ReplicateTokenCard.tsx",
          "operation": "modify",
          "description": "Implement a \"Test token\" action that uses the validation helper, shows a clear success/error state, and (on success) enables saving/using the token so the Create Cover flow becomes enabled immediately without reload."
        },
        {
          "path": "frontend/src/pages/CreateCoverPage.tsx",
          "operation": "modify",
          "description": "Ensure the Create Cover page reacts to successful token validation/save (via the new hook/service) so the main AudioUploadAndSubmit section becomes enabled immediately when a valid token is confirmed."
        }
      ]
    }
  ]
}